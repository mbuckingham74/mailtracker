{% extends "base.html" %}
{% block title %}Dashboard - Mailtrack{% endblock %}
{% block content %}
<h1>Tracked Emails</h1>

{% if tracks %}
<div class="email-list">
    {% for item in tracks %}
    {% if item.is_group %}
    {# Grouped email with multiple recipients #}
    <div class="email-row {% if item.total_real_opens > 0 %}has-opens{% endif %}" data-group-id="{{ item.group_id }}">
        <div class="email-main">
            <div class="email-recipients">
                {% for recipient in item.recipients %}
                    {% if recipient.track.recipient %}
                        {% for email in recipient.track.recipient.split(',') %}
                <span class="recipient-pill {% if recipient.real_open_count > 0 %}opened{% endif %}" title="{{ email.strip() }}">
                    {{ email.strip().split('@')[0] }}
                </span>
                        {% endfor %}
                    {% else %}
                <span class="recipient-pill">Unknown</span>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="email-subject">{{ item.subject or '(no subject)' }}</div>
            <div class="email-meta">
                Sent on {{ to_est(item.created_at).strftime('%b %d, %Y') }} at {{ to_est(item.created_at).strftime('%-I:%M %p') }} EST
            </div>
        </div>
        <div class="email-stats">
            {% if item.first_proxy_open %}
            <div class="delivery-info">
                <span class="delivery-icon">ðŸ“¬</span>
                Delivered to {{ 'iCloud' if item.first_proxy_type == 'apple' else 'Gmail' }} at {{ to_est(item.first_proxy_open).strftime('%-I:%M %p') }} EST
            </div>
            {% endif %}
            <div class="opens-count">
                {{ item.total_real_opens }} open{{ 's' if item.total_real_opens != 1 else '' }}
            </div>
            {% if item.first_real_open %}
            <div class="last-open">Opened {{ to_est(item.first_real_open).strftime('%b %d') }} at {{ to_est(item.first_real_open).strftime('%-I:%M %p') }} EST</div>
            {% endif %}
        </div>
        <div class="email-actions">
            <button class="expand-btn" onclick="toggleGroup('{{ item.group_id }}')" title="Show recipients">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </button>
        </div>
    </div>
    {# Expandable recipient details #}
    <div class="recipient-details" id="group-{{ item.group_id }}" style="display: none;">
        {% for recipient in item.recipients %}
        <div class="recipient-row {% if recipient.real_open_count > 0 %}has-opens{% endif %}">
            <div class="recipient-email">{{ recipient.track.recipient or '-' }}</div>
            <div class="recipient-stats">
                {{ recipient.real_open_count }} open{{ 's' if recipient.real_open_count != 1 else '' }}
                {% if recipient.first_real_open %}
                <span class="recipient-time">{{ to_est(recipient.first_real_open).strftime('%b %d at %-I:%M %p') }} EST</span>
                {% endif %}
            </div>
            <a href="/detail/{{ recipient.track.id }}" class="btn btn-sm">View</a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    {# Single recipient email #}
    <div class="email-row {% if item.real_open_count > 0 %}has-opens{% endif %}">
        <div class="email-main">
            <div class="email-recipients">
                {% if item.track.recipient %}
                    {% for email in item.track.recipient.split(',') %}
                <span class="recipient-pill {% if item.real_open_count > 0 %}opened{% endif %}" title="{{ email.strip() }}">
                    {{ email.strip().split('@')[0] }}
                </span>
                    {% endfor %}
                {% else %}
                <span class="recipient-pill">Unknown</span>
                {% endif %}
            </div>
            <div class="email-subject">{{ item.track.subject or '(no subject)' }}</div>
            <div class="email-meta">
                Sent on {{ to_est(item.track.created_at).strftime('%b %d, %Y') }} at {{ to_est(item.track.created_at).strftime('%-I:%M %p') }} EST
            </div>
        </div>
        <div class="email-stats">
            {% if item.first_proxy_open %}
            <div class="delivery-info">
                <span class="delivery-icon">ðŸ“¬</span>
                Delivered to {{ 'iCloud' if item.first_proxy_type == 'apple' else 'Gmail' }} at {{ to_est(item.first_proxy_open).strftime('%-I:%M %p') }} EST
            </div>
            {% endif %}
            <div class="opens-count">
                {{ item.real_open_count }} open{{ 's' if item.real_open_count != 1 else '' }}
            </div>
            {% if item.first_real_open %}
            <div class="last-open">Opened {{ to_est(item.first_real_open).strftime('%b %d') }} at {{ to_est(item.first_real_open).strftime('%-I:%M %p') }} EST</div>
            {% endif %}
        </div>
        <div class="email-actions">
            <a href="/detail/{{ item.track.id }}" class="expand-btn" title="View details">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </a>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<script>
function toggleGroup(groupId) {
    const details = document.getElementById('group-' + groupId);
    const row = document.querySelector(`[data-group-id="${groupId}"]`);
    if (details.style.display === 'none') {
        details.style.display = 'block';
        row.classList.add('expanded');
    } else {
        details.style.display = 'none';
        row.classList.remove('expanded');
    }
}
</script>
{% else %}
<p class="empty">No tracked emails yet. <a href="/create">Create your first one</a>.</p>
{% endif %}
{% endblock %}
