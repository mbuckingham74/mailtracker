{% extends "base.html" %}
{% block title %}Dashboard - Mailtrack{% endblock %}
{% block content %}
<div class="dashboard-header">
    <div class="dashboard-left">
        <h1>Tracked Emails</h1>
        <div class="filter-row">
            <select class="filter-dropdown" onchange="updateFilters('filter', this.value)">
                <option value="all" {% if filter == 'all' %}selected{% endif %}>All emails</option>
                <option value="unopened" {% if filter == 'unopened' %}selected{% endif %}>Unopened emails</option>
                <option value="opened" {% if filter == 'opened' %}selected{% endif %}>Opened emails</option>
            </select>
            <select class="filter-dropdown" onchange="updateFilters('date_range', this.value)">
                <option value="all" {% if date_range == 'all' %}selected{% endif %}>All time</option>
                <option value="7" {% if date_range == '7' %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if date_range == '30' %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if date_range == '90' %}selected{% endif %}>Last 90 days</option>
            </select>
            <form class="search-form" onsubmit="return submitSearch(event)">
                <input type="text" class="search-input" placeholder="Search recipient or subject..." value="{{ search }}" id="search-input">
                <button type="submit" class="search-btn">Search</button>
                {% if search %}
                <button type="button" class="search-clear" onclick="clearSearch()">Clear</button>
                {% endif %}
            </form>
        </div>
    </div>
    <a href="/export" class="btn btn-secondary">Export CSV</a>
</div>

<script>
function updateFilters(param, value) {
    const url = new URL(window.location.href);
    if (value === 'all') {
        url.searchParams.delete(param);
    } else {
        url.searchParams.set(param, value);
    }
    url.searchParams.delete('page'); // Reset to page 1 when filters change
    window.location.href = url.toString();
}

function submitSearch(e) {
    e.preventDefault();
    const search = document.getElementById('search-input').value.trim();
    const url = new URL(window.location.href);
    if (search) {
        url.searchParams.set('search', search);
    } else {
        url.searchParams.delete('search');
    }
    url.searchParams.delete('page');
    window.location.href = url.toString();
    return false;
}

function clearSearch() {
    const url = new URL(window.location.href);
    url.searchParams.delete('search');
    url.searchParams.delete('page');
    window.location.href = url.toString();
}
</script>

{% if tracks %}
<div class="email-list">
    {% for item in tracks %}
    {% if item.is_group %}
    {# Grouped email with multiple recipients - link to first recipient's detail #}
    <div class="email-row-wrapper {% if item.pinned %}pinned{% endif %}">
        <form action="/pin/{{ item.recipients[0].track.id }}" method="post" class="pin-form">
            <button type="submit" class="pin-btn {% if item.pinned %}active{% endif %}" title="{% if item.pinned %}Unpin{% else %}Pin{% endif %}">
                <span class="pin-icon">&#9733;</span>
            </button>
        </form>
        <a href="/detail/{{ item.recipients[0].track.id }}" class="email-row {% if item.total_real_opens > 0 %}has-opens{% endif %}">
            <div class="email-main">
                <div class="email-recipients">
                {% for recipient in item.recipients %}
                    {% if recipient.track.recipient %}
                        {% for email in recipient.track.recipient.split(',') %}
                <span class="recipient-pill {% if recipient.real_open_count > 0 %}opened{% endif %}" title="{{ email.strip() }}">
                    {{ email.strip().split('@')[0] }}
                </span>
                        {% endfor %}
                    {% else %}
                <span class="recipient-pill">Unknown</span>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="email-subject">{{ item.subject or '(no subject)' }}</div>
            {% if item.recipients[0].track.notes %}
            <div class="notes-display">{{ item.recipients[0].track.notes }}</div>
            {% endif %}
            <div class="email-meta">
                Sent on {{ to_local(item.created_at).strftime('%b %d, %Y at %-I:%M %p %Z') }}
            </div>
        </div>
        <div class="email-stats">
            {% if item.first_proxy_open %}
            <div class="delivery-info">
                <span class="delivery-icon">ðŸ“¬</span>
                Delivered to {{ 'iCloud' if item.first_proxy_type == 'apple' else 'Gmail' }} at {{ to_local(item.first_proxy_open).strftime('%-I:%M %p %Z') }}
            </div>
            {% endif %}
            <div class="opens-count">
                {{ item.total_real_opens }} open{{ 's' if item.total_real_opens != 1 else '' }}
            </div>
            {% if item.first_real_open %}
            <div class="last-open">Opened {{ to_local(item.first_real_open).strftime('%b %d at %-I:%M %p %Z') }}</div>
            {% endif %}
        </div>
    </a>
    </div>
    {% else %}
    {# Single recipient email #}
    <div class="email-row-wrapper {% if item.pinned %}pinned{% endif %}">
        <form action="/pin/{{ item.track.id }}" method="post" class="pin-form">
            <button type="submit" class="pin-btn {% if item.pinned %}active{% endif %}" title="{% if item.pinned %}Unpin{% else %}Pin{% endif %}">
                <span class="pin-icon">&#9733;</span>
            </button>
        </form>
        <a href="/detail/{{ item.track.id }}" class="email-row clickable {% if item.real_open_count > 0 %}has-opens{% endif %}">
            <div class="email-main">
                <div class="email-recipients">
                {% if item.track.recipient %}
                    {% for email in item.track.recipient.split(',') %}
                <span class="recipient-pill {% if item.real_open_count > 0 %}opened{% endif %}" title="{{ email.strip() }}">
                    {{ email.strip().split('@')[0] }}
                </span>
                    {% endfor %}
                {% else %}
                <span class="recipient-pill">Unknown</span>
                {% endif %}
            </div>
            <div class="email-subject">{{ item.track.subject or '(no subject)' }}</div>
            {% if item.track.notes %}
            <div class="notes-display">{{ item.track.notes }}</div>
            {% endif %}
            <div class="email-meta">
                Sent on {{ to_local(item.track.created_at).strftime('%b %d, %Y at %-I:%M %p %Z') }}
            </div>
        </div>
        <div class="email-stats">
            {% if item.first_proxy_open %}
            <div class="delivery-info">
                <span class="delivery-icon">ðŸ“¬</span>
                Delivered to {{ 'iCloud' if item.first_proxy_type == 'apple' else 'Gmail' }} at {{ to_local(item.first_proxy_open).strftime('%-I:%M %p %Z') }}
            </div>
            {% endif %}
            <div class="opens-count">
                {{ item.real_open_count }} open{{ 's' if item.real_open_count != 1 else '' }}
            </div>
            {% if item.first_real_open %}
            <div class="last-open">Opened {{ to_local(item.first_real_open).strftime('%b %d at %-I:%M %p %Z') }}</div>
            {% endif %}
        </div>
    </a>
    </div>
    {% endif %}
    {% endfor %}
</div>

{% if total_pages > 1 %}
<div class="pagination">
    <div class="pagination-info">
        Showing {{ (page - 1) * 25 + 1 }}-{{ [page * 25, total_items] | min }} of {{ total_items }} emails
    </div>
    <div class="pagination-controls">
        {% if page > 1 %}
        <a href="/?{% for k, v in query_params.items() %}{{ k }}={{ v }}&{% endfor %}page={{ page - 1 }}" class="pagination-btn">Previous</a>
        {% else %}
        <span class="pagination-btn disabled">Previous</span>
        {% endif %}

        <span class="pagination-pages">Page {{ page }} of {{ total_pages }}</span>

        {% if page < total_pages %}
        <a href="/?{% for k, v in query_params.items() %}{{ k }}={{ v }}&{% endfor %}page={{ page + 1 }}" class="pagination-btn">Next</a>
        {% else %}
        <span class="pagination-btn disabled">Next</span>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<p class="empty">
    {% if search or filter != 'all' or date_range != 'all' %}
    No emails match your filters. <a href="/">Clear filters</a>
    {% else %}
    No tracked emails yet. Send an email with the Chrome extension to start tracking.
    {% endif %}
</p>
{% endif %}
{% endblock %}
