{% extends "base.html" %}
{% block title %}Dashboard - Mailtrack{% endblock %}
{% block content %}
<div class="dashboard-header">
    <div class="dashboard-left">
        <h1>Tracked Emails</h1>
        <select class="filter-dropdown" onchange="window.location.href='/?filter=' + this.value">
            <option value="all" {% if filter == 'all' %}selected{% endif %}>All emails</option>
            <option value="unopened" {% if filter == 'unopened' %}selected{% endif %}>Unopened emails</option>
            <option value="opened" {% if filter == 'opened' %}selected{% endif %}>Opened emails</option>
        </select>
    </div>
    <a href="/export" class="btn btn-secondary">Export CSV</a>
</div>

{% if tracks %}
<div class="email-list">
    {% for item in tracks %}
    {% if item.is_group %}
    {# Grouped email with multiple recipients - link to first recipient's detail #}
    <a href="/detail/{{ item.recipients[0].track.id }}" class="email-row {% if item.total_real_opens > 0 %}has-opens{% endif %}">
        <div class="email-main">
            <div class="email-recipients">
                {% for recipient in item.recipients %}
                    {% if recipient.track.recipient %}
                        {% for email in recipient.track.recipient.split(',') %}
                <span class="recipient-pill {% if recipient.real_open_count > 0 %}opened{% endif %}" title="{{ email.strip() }}">
                    {{ email.strip().split('@')[0] }}
                </span>
                        {% endfor %}
                    {% else %}
                <span class="recipient-pill">Unknown</span>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="email-subject">{{ item.subject or '(no subject)' }}</div>
            <div class="email-meta">
                Sent on {{ to_local(item.created_at).strftime('%b %d, %Y at %-I:%M %p %Z') }}
            </div>
        </div>
        <div class="email-stats">
            {% if item.first_proxy_open %}
            <div class="delivery-info">
                <span class="delivery-icon">ðŸ“¬</span>
                Delivered to {{ 'iCloud' if item.first_proxy_type == 'apple' else 'Gmail' }} at {{ to_local(item.first_proxy_open).strftime('%-I:%M %p %Z') }}
            </div>
            {% endif %}
            <div class="opens-count">
                {{ item.total_real_opens }} open{{ 's' if item.total_real_opens != 1 else '' }}
            </div>
            {% if item.first_real_open %}
            <div class="last-open">Opened {{ to_local(item.first_real_open).strftime('%b %d at %-I:%M %p %Z') }}</div>
            {% endif %}
        </div>
    </a>
    {% else %}
    {# Single recipient email #}
    <a href="/detail/{{ item.track.id }}" class="email-row clickable {% if item.real_open_count > 0 %}has-opens{% endif %}">
        <div class="email-main">
            <div class="email-recipients">
                {% if item.track.recipient %}
                    {% for email in item.track.recipient.split(',') %}
                <span class="recipient-pill {% if item.real_open_count > 0 %}opened{% endif %}" title="{{ email.strip() }}">
                    {{ email.strip().split('@')[0] }}
                </span>
                    {% endfor %}
                {% else %}
                <span class="recipient-pill">Unknown</span>
                {% endif %}
            </div>
            <div class="email-subject">{{ item.track.subject or '(no subject)' }}</div>
            <div class="email-meta">
                Sent on {{ to_local(item.track.created_at).strftime('%b %d, %Y at %-I:%M %p %Z') }}
            </div>
        </div>
        <div class="email-stats">
            {% if item.first_proxy_open %}
            <div class="delivery-info">
                <span class="delivery-icon">ðŸ“¬</span>
                Delivered to {{ 'iCloud' if item.first_proxy_type == 'apple' else 'Gmail' }} at {{ to_local(item.first_proxy_open).strftime('%-I:%M %p %Z') }}
            </div>
            {% endif %}
            <div class="opens-count">
                {{ item.real_open_count }} open{{ 's' if item.real_open_count != 1 else '' }}
            </div>
            {% if item.first_real_open %}
            <div class="last-open">Opened {{ to_local(item.first_real_open).strftime('%b %d at %-I:%M %p %Z') }}</div>
            {% endif %}
        </div>
    </a>
    {% endif %}
    {% endfor %}
</div>

{% else %}
<p class="empty">No tracked emails yet. Send an email with the Chrome extension to start tracking.</p>
{% endif %}
{% endblock %}
