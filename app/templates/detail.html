{% extends "base.html" %}
{% block title %}{{ track.subject or track.recipient or 'Track Details' }} - Mailtrack{% endblock %}
{% block content %}
<div class="detail-header">
    <h1>Track Details</h1>
    <div class="detail-actions">
        {% if track.recipient or track.subject %}
        <a href="{{ gmail_search_url }}" target="_blank" class="btn btn-secondary">View in Gmail</a>
        {% endif %}
        <form method="post" action="/delete/{{ track.id }}" style="display:inline" onsubmit="return confirm('Delete this track and all opens?')">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

<div class="track-info">
    {% if first_proxy_open %}
    <p class="delivery-info-detail">
        <span class="delivery-icon">ðŸ“¬</span>
        <strong>Delivered to {{ 'iCloud' if first_proxy_type == 'apple' else 'Gmail' }}:</strong>
        {{ to_local(first_proxy_open).strftime('%b %d, %Y at %-I:%M %p %Z') }}
    </p>
    {% endif %}
    <p><strong>Real Opens:</strong> {{ real_open_count }}</p>
    <p class="proxy-note"><strong>Total Opens (including proxy):</strong> {{ opens|length }}</p>
</div>

<div class="notes-section">
    <h3>Notes</h3>
    <form action="/notes/{{ track.id }}" method="post" class="notes-form">
        <textarea name="notes" class="notes-textarea" placeholder="Add notes about this email (e.g., 'Discussed pricing', 'Follow-up needed')...">{{ track.notes or '' }}</textarea>
        <button type="submit" class="btn btn-primary">Save Notes</button>
    </form>
</div>

<h2>All Opens ({{ opens|length }})</h2>
{% if opens %}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>IP Address</th>
            <th>User Agent</th>
            <th>Location</th>
        </tr>
    </thead>
    <tbody>
        {% for open in opens %}
        {% set proxy_type = detect_proxy_type(open.ip_address, open.user_agent or '') %}
        <tr class="{% if proxy_type %}proxy-open{% endif %}">
            <td>{{ open.opened_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>
                {{ open.ip_address or '-' }}
                {% if proxy_type == 'apple' %}
                <span class="proxy-badge apple" title="Apple Mail Privacy Protection - automated prefetch, not a real open">Apple</span>
                {% elif proxy_type == 'google' %}
                <span class="proxy-badge google" title="Gmail Image Proxy - may be cached">Gmail</span>
                {% endif %}
            </td>
            <td class="user-agent">{{ open.user_agent[:80] if open.user_agent else '-' }}{% if open.user_agent and open.user_agent|length > 80 %}...{% endif %}</td>
            <td>{{ open.city or '' }}{% if open.city and open.country %}, {% endif %}{{ open.country or '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="empty">No opens yet.</p>
{% endif %}

<details class="pixel-details">
    <summary>Tracking Pixel Details</summary>
    <div class="track-metadata">
        <p><strong>Recipient:</strong> {{ track.recipient or '-' }}</p>
        <p><strong>Subject:</strong> {{ track.subject or '-' }}</p>
        <p><strong>Notes:</strong> {{ track.notes or '-' }}</p>
        <p><strong>Created:</strong> {{ track.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
    </div>
    <div class="code-block">
        <p><strong>HTML (paste in email):</strong></p>
        <pre><code id="html-snippet">{{ html_snippet }}</code></pre>
        <button onclick="navigator.clipboard.writeText(document.getElementById('html-snippet').textContent)" class="btn btn-sm">Copy HTML</button>
    </div>
    <div class="code-block">
        <p><strong>Pixel URL:</strong></p>
        <pre><code>{{ pixel_url }}</code></pre>
        <button onclick="navigator.clipboard.writeText('{{ pixel_url }}')" class="btn btn-sm">Copy URL</button>
    </div>
</details>
{% endblock %}
